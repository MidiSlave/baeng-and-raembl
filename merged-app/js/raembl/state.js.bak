// File: js/state.js

import { registerRaemblState } from '../state.js';

const localState = {
    // Clock state
    isPlaying: false,
    bpm: 120,
    swing: 0,
    barLength: 4,
    currentStepIndex: -1,
    factorsPatternPos: -1, // Renamed from currentStepIndex for factors pattern
    displayBar: 1,
    displayBeat: 1,
    displayStep: 1,
    isBarStart: false,
    resetFactorsOnBar: false,
    resetLfoOnBar: false,
    clockRequestId: null,
    lastStepTime: 0,
    stepCounter: -1,
    barCounter: 0,
    stepsPerBeat: 4,
    // Factors state
    steps: 16,
    fills: 4,
    rotation: 0,
    accentProb: 0,
    slideProb: 0,
    trillProb: 0, // New Trill Probability
    gateLength: 80, // Gate length percentage (0-100) for sequencer note duration
    gatePattern: [],
    accentPattern: [],
    slidePattern: [],
    trillPattern: [], // New Trill Pattern
    factorsAnimationMode: 'animated', // 'static' or 'animated' - controls visualization mode
    // LFO state
    lfoAmp: 36,
    lfoFreq: 36,
    lfoWaveform: 0,
    lfoOffset: 0,
    lfoValue: 0,
    lfoStartTime: performance.now(),
    // Mod LFO state
    modLfoRate: 50,
    modLfoWaveform: 0,
    modLfoValue: 0,
    // Path state
    sample: 50,
    prevSample: 30,
    scale: 3, // Default to Pentatonic Major (index 3 if Chromatic is 0, Major 1, Minor 2)
              // Check your scales array in utils.js for correct default index.
              // Assuming Pentatonic Major is a reasonable default.
    root: 0,
    probability: 100,
    currentNote: 'C3',
    triggerSample: false,
    sampleTime: Date.now(),
    isTransitioning: false,
    pathAnimationMode: 'animated', // 'static' or 'animated' - controls visualization mode
    stepPitches: [], // Array of pitch values (0-100) for each step in the sequence
    // Reverb state
    reverbMix: 25,  // 25% send level - audible but subtle
    diffusion: 60,
    preDelay: 10,
    reverbDecay: 70, // Note: Original state.js had 'decay', this is now 'reverbDecay'
    damping: 20,
    // Delay state
    delayMix: 25,   // 25% send level - audible but subtle
    delayTime: 50,      // For SYNC mode (0-100, maps to divisions)
    delayTimeFree: 50,  // For FREE mode (0-100, maps to ms)
    delaySyncEnabled: true, // true for SYNC, false for FREE
    feedback: 40,
    wow: 10,
    flutter: 5,
    saturation: 0,
    // Oscillator state
    mainTransposition: 4,
    subTransposition: 2,
    drift: 10,
    glide: 0,
    pulseWidth: 50,
    pwmAmount: 0,
    pitchMod: 0,
    pwmSource: 0,
    modSource: 0,
    monoMode: true,
    // Mixer state
    sawLevel: 75,
    squareLevel: 0,
    triangleLevel: 0,
    subLevel: 50,
    noiseLevel: 0,
    // Filter state
    highPass: 0,
    lowPass: 75,
    resonance: 20,
    keyFollow: 0,
    envAmount: 50,
    filterMod: 0,
    // Envelope state
    attack: 0,
    decay: 25,
    sustain: 50,
    release: 75,
    // Output state
    volume: 75,

    // --- MIDI CC Mappings ---
    midiCCMappings: [
        // Example initial mappings (can be empty)
        // { cc: 74, parameterId: 'filter.lowPass' },
        // { cc: 1, parameterId: 'modLfo.rate' }
    ],

    // --- Per-Parameter Modulation System ---
    perParamModulations: {
        // Sparse storage - only store active modulations
        // Example structure:
        // 'filter.lowPass': {
        //     enabled: true,
        //     waveform: 0,      // 0-5 (sin/tri/sq/saw/noise/sh)
        //     rate: 2.5,        // Hz (0.05-30, log scale)
        //     depth: 60,        // 0-100%
        //     offset: 0,        // -100 to +100%
        //     resetMode: 'step' // 'off'|'step'|'accent'|'bar'
        // }
    },

    // --- Modulation Edit Mode State ---
    modEditMode: {
        activeParamId: null,  // Which parameter is being edited
        currentPage: 0,       // 0=normal, 1=wave, 2=rate, 3=offset, 4=depth, 5=reset
        inactivityTimer: null,      // Timer reference for auto-return to normal view
        lastInteractionTime: null,   // Timestamp of last interaction
        // UI element references for restoring previous param when switching
        activeLabelEl: null,
        activeFill: null,
        activeValueDisplay: null,
        activeVerticalText: null
    }
};

export const parameterDefinitions = {
    // Clock
    'clock.bpm': { statePath: 'bpm', min: 20, max: 300, module: 'clock', label: 'BPM' },
    'clock.swing': { statePath: 'swing', min: 0, max: 100, module: 'clock', label: 'SWING' },
    'clock.length': { statePath: 'barLength', min: 1, max: 16, step: 1, module: 'clock', label: 'LENGTH' },
    // Factors
    'factors.steps': { statePath: 'steps', min: 1, max: 32, step: 1, module: 'factors', label: 'STEPS' },
    'factors.fills': { statePath: 'fills', min: 0, max: 32, step: 1, module: 'factors', label: 'FILLS' },
    'factors.shift': { statePath: 'rotation', min: 0, max: 31, step: 1, module: 'factors', label: 'SHIFT' },
    'factors.accentProb': { statePath: 'accentProb', min: 0, max: 100, module: 'factors', label: '>' },
    'factors.slideProb': { statePath: 'slideProb', min: 0, max: 100, module: 'factors', label: 'SLIDE' },
    'factors.trillProb': { statePath: 'trillProb', min: 0, max: 100, module: 'factors', label: 'TR' }, // New Trill Parameter
    'factors.gateLength': { statePath: 'gateLength', min: 5, max: 100, module: 'factors', label: 'GATE' },
    // LFO (Main)
    'lfo.amp': { statePath: 'lfoAmp', min: 0, max: 100, module: 'lfo', label: 'AMP' },
    'lfo.freq': { statePath: 'lfoFreq', min: 0, max: 100, module: 'lfo', label: 'FREQ' },
    'lfo.waveform': { statePath: 'lfoWaveform', min: 0, max: 100, module: 'lfo', label: 'WAVE' },
    'lfo.offset': { statePath: 'lfoOffset', min: -100, max: 100, module: 'lfo', label: 'OFFSET' },
    // Path
    'path.scale': { statePath: 'scale', min: 0, max: 31, step:1, module: 'path', label: 'SCALE' }, // Max depends on scales array length
    'path.root': { statePath: 'root', min: 0, max: 11, step:1, module: 'path', label: 'ROOT' },
    'path.probability': { statePath: 'probability', min: 0, max: 100, module: 'path', label: 'PROB' },
    // Reverb
    'reverb.mix': { statePath: 'reverbMix', min: 0, max: 100, module: 'reverb', label: 'SEND', modulatable: true },
    'reverb.preDelay': { statePath: 'preDelay', min: 0, max: 100, module: 'reverb', label: 'PRED', modulatable: true },
    'reverb.decay': { statePath: 'reverbDecay', min: 0, max: 100, module: 'reverb', label: 'DEC', modulatable: true },
    'reverb.diffusion': { statePath: 'diffusion', min: 0, max: 100, module: 'reverb', label: 'DIFF', modulatable: true },
    'reverb.damping': { statePath: 'damping', min: 0, max: 100, module: 'reverb', label: 'DAMP', modulatable: true },
    // Delay
    'delay.mix': { statePath: 'delayMix', min: 0, max: 100, module: 'delay', label: 'SEND', modulatable: true },
    'delay.time': { // This ID now refers to either sync or free time based on state.delaySyncEnabled
        statePath: 'delayTime', // Default path, logic in faderState/updateParameterById will handle routing
        min: 0, max: 100, module: 'delay', label: 'TIME', modulatable: true
    },
    'delay.feedback': { statePath: 'feedback', min: 0, max: 100, module: 'delay', label: 'FDBK', modulatable: true },
    'delay.wow': { statePath: 'wow', min: 0, max: 100, module: 'delay', label: 'WOW', modulatable: true },
    'delay.flutter': { statePath: 'flutter', min: 0, max: 100, module: 'delay', label: 'FLUT', modulatable: true },
    'delay.saturation': { statePath: 'saturation', min: 0, max: 100, module: 'delay', label: 'SAT', modulatable: true },
    'delay.syncEnabled': { statePath: 'delaySyncEnabled', type: 'boolean', module: 'delay', label: 'SYNC_TOGGLE' }, // Not a fader
    // Mod LFO
    'modLfo.rate': { statePath: 'modLfoRate', min: 0, max: 100, module: 'mod', label: 'RATE', modulatable: true },
    'modLfo.waveform': { statePath: 'modLfoWaveform', min: 0, max: 100, step: 25, module: 'mod', label: 'WAVE', modulatable: true },
    // Oscillator
    'osc.oct': { statePath: 'mainTransposition', min: 0, max: 8, step: 1, module: 'oscillator', label: 'OCT', modulatable: true },
    'osc.subOct': { statePath: 'subTransposition', min: 0, max: 8, step: 1, module: 'oscillator', label: 'SUB OCT', modulatable: true },
    'osc.drift': { statePath: 'drift', min: 0, max: 100, module: 'oscillator', label: 'DRIFT', modulatable: true },
    'osc.glide': { statePath: 'glide', min: 0, max: 100, module: 'oscillator', label: 'GLIDE', modulatable: true },
    'osc.pulseWidth': { statePath: 'pulseWidth', min: 5, max: 95, module: 'oscillator', label: 'WIDTH', modulatable: true },
    'osc.pwmAmount': { statePath: 'pwmAmount', min: 0, max: 100, module: 'oscillator', label: 'PWM', modulatable: true },
    'osc.pitchMod': { statePath: 'pitchMod', min: 0, max: 100, module: 'oscillator', label: 'MOD', modulatable: true },
    // Mixer
    'mixer.sawLevel': { statePath: 'sawLevel', min: 0, max: 100, module: 'mixer', label: '◢', modulatable: true },
    'mixer.squareLevel': { statePath: 'squareLevel', min: 0, max: 100, module: 'mixer', label: '⊓', modulatable: true },
    'mixer.triangleLevel': { statePath: 'triangleLevel', min: 0, max: 100, module: 'mixer', label: '△', modulatable: true },
    'mixer.subLevel': { statePath: 'subLevel', min: 0, max: 100, module: 'mixer', label: '■', modulatable: true },
    'mixer.noiseLevel': { statePath: 'noiseLevel', min: 0, max: 100, module: 'mixer', label: '≋', modulatable: true },
    // Filter
    'filter.highPass': { statePath: 'highPass', min: 0, max: 100, module: 'filter', label: 'HP', modulatable: true },
    'filter.lowPass': { statePath: 'lowPass', min: 0, max: 100, module: 'filter', label: 'LP', modulatable: true },
    'filter.resonance': { statePath: 'resonance', min: 0, max: 100, module: 'filter', label: 'RES', modulatable: true },
    'filter.keyFollow': { statePath: 'keyFollow', min: 0, max: 100, module: 'filter', label: 'KEY', modulatable: true },
    'filter.envAmount': { statePath: 'envAmount', min: 0, max: 100, module: 'filter', label: 'ENV', modulatable: true },
    'filter.mod': { statePath: 'filterMod', min: 0, max: 100, module: 'filter', label: 'MOD', modulatable: true },
    // Envelope
    'envelope.attack': { statePath: 'attack', min: 0, max: 100, module: 'envelope', label: 'A', modulatable: true },
    'envelope.decay': { statePath: 'decay', min: 0, max: 100, module: 'envelope', label: 'D', modulatable: true },
    'envelope.sustain': { statePath: 'sustain', min: 0, max: 100, module: 'envelope', label: 'S', modulatable: true },
    'envelope.release': { statePath: 'release', min: 0, max: 100, module: 'envelope', label: 'R', modulatable: true },
    // Output
    'output.volume': { statePath: 'volume', min: 0, max: 100, module: 'output', label: 'VOL' },
};

// Register state with merged state manager and export the proxy
export const state = registerRaemblState(localState);

// Note: parameterDefinitions uses the exported state proxy for all operations.